<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisky Recommender Demo</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #fafafa; }
    .panel { background: #fff; border: 1px solid #eee; border-radius: 16px; }
    .section-title { font-weight: 800; }
    .h-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }
    .h-scroll::-webkit-scrollbar { height: 10px; }
    .h-scroll .card { min-width: 280px; scroll-snap-align: start; }
    .muted { color: #666; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#f2f2f2; display:inline-block; }
    .none-badge { font-size: 12px; color: #b00020; font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="py-4">
<div class="container">
  <div class="mb-3">
    <h1 class="mb-1">Whisky Recommender Demo</h1>
    <div class="muted">Survey → Taste(FA/partial) + Meta(OneHot KNN) + Rare Personalized</div>
  </div>

  <!-- 입력 패널 -->
  <div class="panel p-3 p-md-4 mb-4">
    <form method="POST" action="{{ url_for('recommend') }}">
      <div class="row g-3">

        {% set sliders = [
          ("style_body", "Body"),
          ("style_richness", "Richness"),
          ("style_smoke", "Smoke"),
          ("style_sweetness", "Sweetness")
        ] %}

        {# None 상태를 서버에서 명시적으로 넘기기: input_state["none_keys"] = ["style_body", ...] #}
        {% set none_keys = input_state.get("none_keys", []) if input_state is defined else [] %}

        {% for key, label in sliders %}
          {% set is_none = (key in none_keys) %}
          {% set default_val = 2.5 %}
          {% set current_val = input_state.get(key) if (input_state is defined and input_state.get(key) is not none) else default_val %}
          <div class="col-12 col-md-6">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <div>
                <div class="fw-bold">{{ label }}</div>
                <div class="muted small">0 ~ 5</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span id="{{ key }}_status" class="none-badge" style="display:none;">None</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="setNone('{{ key }}')">None</button>
              </div>
            </div>

            <!-- 서버로 넘어가는 hidden input: None이면 빈 문자열, 아니면 숫자 -->
            <input
              type="hidden"
              name="{{ key }}"
              id="{{ key }}_hidden"
              value="{% if is_none %}{% else %}{{ current_val }}{% endif %}"
              data-is-none="{% if is_none %}1{% else %}0{% endif %}"
            >

            <!-- 사용자가 조작하는 range -->
            <input
              type="range"
              class="form-range"
              min="0" max="5" step="0.5"
              id="{{ key }}_range"
              value="{{ current_val }}"
              oninput="syncRange('{{ key }}')"
              onchange="syncRange('{{ key }}')"
            />

            <div class="d-flex justify-content-between small muted">
              <span>0</span>
              <span class="mono">value: <span id="{{ key }}_val"></span></span>
              <span>5</span>
            </div>
          </div>
        {% endfor %}

        <!-- family 선택 -->
        <div class="col-12">
          <div class="fw-bold mb-2">Flavour Families (selectable)</div>
          <div class="panel p-3" style="background:#fcfcfc;">
            <div class="row g-2">
              {% for fam in family_options %}
              <div class="col-6 col-md-3 col-lg-2">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="families"
                    value="{{ fam }}"
                    id="fam_{{ fam }}"
                    {% if input_state is defined and fam in input_state.selected_families %}checked{% endif %}
                  >
                  <label class="form-check-label" for="fam_{{ fam }}">{{ fam }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="muted small mt-2">선택 안 하면 family filter 없이 추천해요.</div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-dark">Recommend</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Reset</a>
        </div>
      </div>
    </form>
  </div>

  {% if has_results %}
  <!-- 결과 섹션: 메인 추천 -->
  <div class="mb-4">
    <div class="d-flex align-items-end justify-content-between mb-2">
      <div>
        <div class="section-title h4 mb-0">추천 제품</div>
        <div class="muted small">7개씩 표시 (Page {{ main_page }} / {{ main_total_pages }})</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary {% if main_page <= 1 %}disabled{% endif %}"
           href="{{ url_for('recommend', main_page=main_page-1, rare_page=rare_page) }}">Prev</a>
        <a class="btn btn-sm btn-outline-secondary {% if main_page >= main_total_pages %}disabled{% endif %}"
           href="{{ url_for('recommend', main_page=main_page+1, rare_page=rare_page) }}">Next</a>
      </div>
    </div>

    <div class="h-scroll">
      {% for item in main_cards %}
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-1">{{ item.name }}</div>

          <div class="d-flex flex-wrap gap-2 mb-2">
            {% if item.whisky_type %}<span class="pill">{{ item.whisky_type }}</span>{% endif %}
            {% if item.region %}<span class="pill">{{ item.region }}</span>{% endif %}
            {% if item.cask_group %}<span class="pill">{{ item.cask_group }}</span>{% endif %}
          </div>

          <div class="small">
            <div><span class="muted">Age:</span> {{ item.age if item.age is not none else "—" }}</div>
            <div><span class="muted">Vintage:</span> {{ item.vintage if item.vintage is not none else "—" }}</div>
            <div><span class="muted">Price(£):</span> {{ item["price(£)"] if item["price(£)"] is not none else "—" }}</div>
            <div><span class="muted">ABV:</span> {{ item.abv if item.abv is not none else "—" }}</div>
          </div>

          <hr class="my-2" />

          <div class="small mono">
            <div>final_score: {{ "%.3f"|format(item.final_score) if item.final_score is not none else "—" }}</div>
            <div>taste_d: {{ "%.3f"|format(item.taste_distance) if item.taste_distance is not none else "—" }}</div>
            <div>meta_d: {{ "%.3f"|format(item.meta_distance) if item.meta_distance is not none else "—" }}</div>
            <div>family_match: {{ item.family_match if item.family_match is not none else 0 }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- 결과 섹션: 희귀 개인화 -->
  <div class="mb-5">
    <div class="d-flex align-items-end justify-content-between mb-2">
      <div>
        <div class="section-title h4 mb-0">고객님을 위한 희귀 제품</div>
        <div class="muted small">7개씩 표시 (Page {{ rare_page }} / {{ rare_total_pages }})</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary {% if rare_page <= 1 %}disabled{% endif %}"
           href="{{ url_for('recommend', main_page=main_page, rare_page=rare_page-1) }}">Prev</a>
        <a class="btn btn-sm btn-outline-secondary {% if rare_page >= rare_total_pages %}disabled{% endif %}"
           href="{{ url_for('recommend', main_page=main_page, rare_page=rare_page+1) }}">Next</a>
      </div>
    </div>

    <div class="h-scroll">
      {% for item in rare_cards %}
      <div class="card shadow-sm border-warning">
        <div class="card-body">
          <div class="fw-bold mb-1">{{ item.name }}</div>

          <div class="d-flex flex-wrap gap-2 mb-2">
            {% if item.whisky_type %}<span class="pill">{{ item.whisky_type }}</span>{% endif %}
            {% if item.region %}<span class="pill">{{ item.region }}</span>{% endif %}
            <span class="pill">RARE</span>
          </div>

          <div class="small">
            <div><span class="muted">Age:</span> {{ item.age if item.age is not none else "—" }}</div>
            <div><span class="muted">Vintage:</span> {{ item.vintage if item.vintage is not none else "—" }}</div>
            <div><span class="muted">Price(£):</span> {{ item["price(£)"] if item["price(£)"] is not none else "—" }}</div>
          </div>

          <hr class="my-2" />

          <div class="small mono">
            <div>rare_meta_d: {{ "%.3f"|format(item.rare_meta_distance) if item.rare_meta_distance is not none else "—" }}</div>
            <div>family_match: {{ item.family_match if item.family_match is not none else 0 }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
  function syncRange(key) {
    const range = document.getElementById(key + "_range");
    const hidden = document.getElementById(key + "_hidden");
    const status = document.getElementById(key + "_status");
    const valSpan = document.getElementById(key + "_val");

    // 사용자가 움직이면 None 해제
    hidden.value = range.value;
    hidden.dataset.isNone = "0";
    status.style.display = "none";
    range.disabled = false;
    valSpan.textContent = range.value;
  }

  function setNone(key) {
    const range = document.getElementById(key + "_range");
    const hidden = document.getElementById(key + "_hidden");
    const status = document.getElementById(key + "_status");
    const valSpan = document.getElementById(key + "_val");

    hidden.value = "";            // 서버에서는 "" -> None 처리
    hidden.dataset.isNone = "1";
    status.style.display = "inline";
    range.disabled = true;        // None이면 슬라이더 잠금
    valSpan.textContent = "None";
  }

  // 초기 렌더링: 서버가 지정한 none_keys만 None 처리. (초기 GET에서 슬라이더 먹통 방지)
  window.addEventListener("DOMContentLoaded", () => {
    const keys = ["style_body","style_richness","style_smoke","style_sweetness"];
    keys.forEach((k) => {
      const hidden = document.getElementById(k + "_hidden");
      const range = document.getElementById(k + "_range");
      const status = document.getElementById(k + "_status");
      const valSpan = document.getElementById(k + "_val");

      const isNone = (hidden.dataset.isNone === "1");

      if (isNone) {
        status.style.display = "inline";
        range.disabled = true;
        valSpan.textContent = "None";
      } else {
        // hidden이 비어있으면(초기 상태) range value로 채워서 추천이 안 나오는 문제 방지
        if (!hidden.value) hidden.value = range.value;
        range.disabled = false;
        valSpan.textContent = range.value;
      }
    });
  });
</script>

</body>
</html>
